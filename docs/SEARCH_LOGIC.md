# 🔍 검색 시스템 작동 로직 (Search System Logic)

이 문서는 YouTube Searcher 애플리케이션의 검색 시스템이 어떻게 작동하는지 단계별로 설명합니다.

## 📋 목차

1. [검색 로직 개요](#검색-로직-개요)
2. [단계별 상세 설명](#단계별-상세-설명)
3. [핵심 포인트](#핵심-포인트)
4. [예시 시나리오](#예시-시나리오)

---

## 검색 로직 개요

검색 시스템은 **서버 우선 전략(Server-First Strategy)**을 사용하여 YouTube API 호출을 최소화하고 성능을 최적화합니다.

### 데이터 소스 우선순위

1. **1순위: 서버(Supabase) 데이터** - API 호출 여부 결정 기준
2. **2순위: 로컬 캐시** - 백업용, 서버 연결 실패 시에만 사용

---

## 단계별 상세 설명

### 1단계: 초기 검증 및 준비

#### 1.1 중복 검색 방지
- 이미 검색이 진행 중이면 새로운 검색 요청을 무시합니다.
- `isSearching` 플래그로 상태를 관리합니다.

#### 1.2 UI 상태 변경
- 검색 버튼과 입력 필드를 비활성화합니다.
- 검색 버튼 텍스트를 "검색 중..."으로 변경합니다.

#### 1.3 검색어 추출 및 유효성 검사
- 입력 필드에서 검색어를 추출합니다.
- 검색어가 비어있으면 경고 메시지를 표시하고 종료합니다.

#### 1.4 로그인 확인
- 공개 쿼리("인생사연" 등)가 아닌 경우 로그인 상태를 확인합니다.
- 로그인하지 않은 경우 로그인 모달을 표시하고 종료합니다.

#### 1.5 API 키 확인
- YouTube API 키가 설정되어 있는지 확인합니다.
- API 키가 없으면 경고 메시지를 표시하고 종료합니다.

#### 1.6 첫 검색 시 페이지 새로고침
- `shouldReload=false`인 경우 (사용자가 직접 검색 버튼 클릭):
  - 검색어를 localStorage에 저장합니다.
  - 페이지를 새로고침합니다.
  - 새로고침 후 `shouldReload=true`로 자동 검색이 실행됩니다.

---

### 2단계: 로컬 캐시 확인 (백업용)

#### 2.1 로컬 캐시 로드
- `loadFromLocalCache(query)` 함수로 로컬 캐시를 확인합니다.
- 로컬 캐시는 **백업용**으로만 사용되며, API 호출 결정에는 영향을 주지 않습니다.

#### 2.2 로컬 캐시 정보 저장
- 로컬 캐시가 있으면 개수를 기록합니다.
- 서버 연결 실패 시에만 사용됩니다.

---

### 3단계: 서버(Supabase) 데이터 확인

#### 3.1 Supabase 데이터 로드
- `loadFromSupabase(query, true)` 함수로 서버 데이터를 로드합니다.
- `ignoreExpiry=true`로 설정하여 캐시 만료 시간을 무시합니다 (TTL 제거됨).

#### 3.2 서버 연결 실패 처리
- **서버 연결 실패 시:**
  - 로컬 캐시가 있으면 → 로컬 캐시를 사용하고 종료합니다.
  - 로컬 캐시도 없으면 → 에러 메시지를 표시하고 종료합니다.

#### 3.3 목표 개수 설정
- `getMaxResults()` 함수로 사용자가 선택한 최대 결과 수를 확인합니다.
- 'max'인 경우 `MAX_RESULTS_LIMIT` (200개)를 사용합니다.
- 숫자인 경우 해당 값을 사용합니다.

---

### 4단계: 서버 데이터가 있는 경우

#### 4.1 데이터 정합성 확인 및 수정

**total_count 불일치 감지:**
- `search_cache.total_count`와 실제 비디오 개수를 비교합니다.
- `total_count > 실제 비디오 개수`인 경우:
  - Supabase의 `search_cache` 테이블에서 `total_count`를 실제 비디오 개수로 자동 업데이트합니다.
  - 콘솔에 경고 메시지를 출력합니다.

#### 4.2 충분한 데이터 확인 (우선순위 순서)

##### 4.2.1 MAX_RESULTS_LIMIT 체크 (최우선)
- **조건:** `supabaseCount >= MAX_RESULTS_LIMIT` (200개 이상)
- **동작:**
  - 서버 데이터를 복원합니다.
  - 로컬 캐시를 서버 데이터로 동기화합니다.
  - 페이지를 렌더링합니다.
  - 백그라운드에서 NULL 데이터 자동 업데이트를 시작합니다.
  - **YouTube API 호출 없음** ✅

##### 4.2.2 목표 개수 체크
- **조건:** `supabaseCount >= targetCount` 또는 `supabaseTotal >= targetCount`
- **동작:**
  - 서버 데이터를 복원합니다.
  - 로컬 캐시를 서버 데이터로 동기화합니다.
  - 페이지를 렌더링합니다.
  - 백그라운드에서 NULL 데이터 자동 업데이트를 시작합니다.
  - **YouTube API 호출 없음** ✅

#### 4.3 데이터 부족 시 추가 검색

##### 4.3.1 서버 데이터 복원
- 기존 서버 데이터를 `allVideos`, `allItems`에 복원합니다.
- 로컬 캐시를 서버 데이터로 동기화합니다.

##### 4.3.2 필요한 개수 계산
```javascript
const neededCount = Math.min(
    targetCount - supabaseCount,
    MAX_RESULTS_LIMIT - supabaseCount
);
```

##### 4.3.3 기존 비디오 ID 제외
- 서버에 저장된 모든 비디오 ID를 수집합니다.
- 이 ID들을 제외하고 YouTube API를 호출하여 중복을 방지합니다.

##### 4.3.4 추가 검색 실행
- `fetchAdditionalVideos(query, apiKeyValue, neededCount, existingVideoIds)` 함수를 호출합니다.
- 필요한 개수만큼만 추가로 검색합니다.
- 검색 결과는 서버에 저장되고 페이지가 업데이트됩니다.

---

### 5단계: 서버 데이터가 없는 경우

#### 5.1 로컬 캐시 백업 표시 (선택적)
- 로컬 캐시가 있으면 백업용으로 표시합니다.
- 빠른 로딩을 위해 사용자에게 즉시 표시할 수 있습니다.
- **하지만 API 호출 결정에는 영향을 주지 않습니다.**

#### 5.2 YouTube API 호출
- `performFullGoogleSearch(query, apiKeyValue)` 함수를 호출합니다.
- 전체 검색을 수행하여 새로운 데이터를 가져옵니다.
- 검색 결과는 Supabase에 저장되고 페이지가 업데이트됩니다.

---

## 핵심 포인트

### 1. 서버 우선 전략
- **Supabase 데이터가 API 호출 여부를 결정합니다.**
- 로컬 캐시는 서버 연결 실패 시에만 사용됩니다.

### 2. API 호출 최소화
- Supabase에 200개 이상 있으면 **API 호출 없음**
- 목표 개수 이상 있으면 **API 호출 없음**
- 필요한 개수만 추가로 검색하여 API 할당량을 절약합니다.

### 3. 중복 방지
- 기존 비디오 ID를 제외하고 추가 검색을 수행합니다.
- `excludeVideoIds` 파라미터로 중복을 방지합니다.

### 4. 자동 동기화
- 서버 데이터로 로컬 캐시를 자동 업데이트합니다.
- 서버가 항상 단일 진실 소스(Single Source of Truth)입니다.

### 5. 데이터 정합성
- `total_count`와 실제 비디오 개수의 불일치를 자동으로 감지하고 수정합니다.
- 중복 제거 후 실제 저장 개수로 `total_count`를 업데이트합니다.

### 6. 백그라운드 업데이트
- NULL 데이터가 있는 비디오는 백그라운드에서 자동으로 업데이트됩니다.
- 사용자 경험을 방해하지 않으면서 데이터를 보완합니다.

---

## 예시 시나리오

### 시나리오 1: "인생사연" 검색 (200개 이상 저장됨)

1. **1단계:** 검색어 유효성 검사 통과
2. **2단계:** 로컬 캐시 확인 (백업용)
3. **3단계:** Supabase에서 데이터 로드
   - 결과: 200개 비디오 발견
4. **4단계:** MAX_RESULTS_LIMIT 체크
   - 조건: `200 >= 200` ✅
   - **결과: API 호출 없음** ✅
   - 서버 데이터 복원 및 페이지 렌더링
   - 로컬 캐시 동기화
   - 백그라운드 NULL 데이터 업데이트 시작

**총 API 호출: 0개**

---

### 시나리오 2: "인생사연" 검색 (150개 저장됨)

1. **1단계:** 검색어 유효성 검사 통과
2. **2단계:** 로컬 캐시 확인 (백업용)
3. **3단계:** Supabase에서 데이터 로드
   - 결과: 150개 비디오 발견
4. **4단계:** MAX_RESULTS_LIMIT 체크
   - 조건: `150 < 200` ❌
5. **4단계:** 목표 개수 체크
   - 조건: `150 < 200` ❌
6. **4.3단계:** 추가 검색 필요
   - `neededCount = min(200 - 150, 200 - 150) = 50`
   - 기존 150개 비디오 ID 제외
   - 50개만 추가 검색
   - 결과를 Supabase에 저장

**총 API 호출: 1-2개** (50개를 가져오기 위해)

---

### 시나리오 3: "새로운 키워드" 검색 (데이터 없음)

1. **1단계:** 검색어 유효성 검사 통과
2. **2단계:** 로컬 캐시 확인 (없음)
3. **3단계:** Supabase에서 데이터 로드
   - 결과: 데이터 없음
4. **5단계:** YouTube API 호출
   - `performFullGoogleSearch()` 실행
   - 검색 결과를 Supabase에 저장
   - 페이지 렌더링

**총 API 호출: 여러 개** (전체 검색 수행)

---

### 시나리오 4: 서버 연결 실패

1. **1단계:** 검색어 유효성 검사 통과
2. **2단계:** 로컬 캐시 확인
   - 결과: 100개 비디오 발견 (백업용)
3. **3단계:** Supabase에서 데이터 로드 시도
   - 결과: 서버 연결 실패 ❌
4. **3.2단계:** 서버 연결 실패 처리
   - 로컬 캐시 사용 (100개)
   - 페이지 렌더링
   - **API 호출 없음** (서버 연결 실패로 인해)

**총 API 호출: 0개** (서버 연결 실패)

---

## 데이터 흐름도

```
사용자 검색 요청
    ↓
[1단계] 초기 검증 및 준비
    ↓
[2단계] 로컬 캐시 확인 (백업용)
    ↓
[3단계] Supabase 데이터 확인
    ↓
    ├─ 서버 연결 실패 → 로컬 캐시 사용 → 종료
    │
    └─ 서버 연결 성공
           ↓
    [4단계] 서버 데이터 처리
           ↓
           ├─ 200개 이상 → API 호출 없음 → 종료 ✅
           │
           ├─ 목표 개수 이상 → API 호출 없음 → 종료 ✅
           │
           └─ 데이터 부족 → 추가 검색 (필요한 개수만) → 종료
    │
    └─ 서버 데이터 없음
           ↓
    [5단계] YouTube API 호출 (전체 검색)
           ↓
           종료
```

---

## 관련 파일

- `js/ui.js` - 검색 로직 구현 (`search()` 함수)
- `js/supabase-api.js` - Supabase 데이터 로드/저장 (`loadFromSupabase()`, `saveToSupabase()`)
- `js/api.js` - YouTube API 호출 (`searchYouTubeAPI()`, `fetchAdditionalVideos()`)

---

## 업데이트 이력

- **2025-01-XX**: 초기 문서 작성
- 검색 로직의 서버 우선 전략 및 API 호출 최소화 로직 문서화

---

## 참고사항

- 이 로직은 `MAX_RESULTS_LIMIT = 200`을 기준으로 합니다.
- TTL(Time To Live) 캐시 만료는 제거되었습니다. 비디오 데이터는 영구적으로 유지됩니다.
- `total_count` 불일치 감지 및 자동 수정 기능이 포함되어 있습니다.

