# 📊 데이터 구축 및 분석 데이터 분석

현재 설정 기준으로 하루에 구축되는 데이터와 분석용 데이터를 상세히 분석합니다.

---

## 1️⃣ 하루에 몇 개 영상이 데이터베이스에 구축될까?

### Search Keyword Updater 동작 방식

**실행 주기**: 매일 오전 3시 (하루 1회)
**검색어 개수**: 약 50개
**검색 결과**: 검색어당 최대 50개 (YouTube API 제한)

### 일일 영상 구축 계산

#### 이론적 최대치

```
검색어 수: 50개
검색어당 최대 결과: 50개
이론적 최대: 50 × 50 = 2,500개 영상
```

#### 실제 구축되는 영상 수

**시나리오 1: 초기 구축 (데이터베이스가 비어있을 때)**
- 첫 실행 시: 최대 2,500개 영상 추가 가능
- 중복 제거 후: 약 2,000~2,500개 (검색어 간 중복 영상 제거)

**시나리오 2: 정상 운영 (이미 데이터가 있을 때)**

**새로 추가되는 영상**:
- 각 검색어마다 새로운 영상만 추가
- 기존 영상은 키워드 배열에 키워드만 추가 (중복 저장 안 함)
- 예상: **일일 100~500개** (검색어당 평균 2~10개 신규 영상)

**업데이트되는 영상**:
- 기존 영상의 메타데이터 업데이트 (title, description, duration, tags 등)
- 키워드 배열 업데이트 (새로운 검색어에 매칭된 경우)

### 일일 영상 구축 요약

| 시나리오 | 일일 추가 영상 수 | 일일 업데이트 영상 수 |
|---------|-----------------|-------------------|
| **초기 구축** | 2,000~2,500개 | 0개 |
| **정상 운영** | 100~500개 | 500~2,000개 |
| **평균 (정상 운영)** | **약 300개** | **약 1,000개** |

### 누적 데이터

**1주일 후**:
- 초기 구축: 2,500개
- 추가: 300 × 7 = 2,100개
- **총합**: 약 4,600개 (중복 제거 후)

**1개월 후**:
- 초기 구축: 2,500개
- 추가: 300 × 30 = 9,000개
- **총합**: 약 11,500개 (중복 제거 후)

**최대 제한**:
- 키워드당 최대 1,000개 저장 가능
- 50개 검색어: 최대 50,000개 (이론적)
- 실제로는 중복이 많아 **약 20,000~30,000개** 정도

---

## 2️⃣ VPH 같은 분석용 데이터는 몇 개? 어떤 순서로?

### 분석용 데이터 종류

1. **VPH (Views Per Hour)** - 조회수 시간당 변화
2. **View Count** - 현재 조회수
3. **Like Count** - 좋아요 수
4. **Subscriber Count** - 구독자 수
5. **Comment Count** - 댓글 수

### 데이터 수집 주기 및 순서

#### 1. VPH 데이터 (조회수 시간당 변화)

**수집 주기**: 매 시간 정각 (00:00, 01:00, 02:00, ...)
**Edge Function**: `hourly-vph-updater`
**대상 비디오**: `view_tracking_config.video_ids` (최대 5,000개)

**데이터 저장**:
- 테이블: `view_history`
- 저장 데이터: `video_id`, `view_count`, `fetched_at`
- 비디오당 시간당 1개 레코드

**일일 데이터 생성량**:
```
추적 비디오 수: 5,000개
시간당 레코드: 5,000개
일일 레코드: 5,000 × 24 = 120,000개
```

**데이터 보관**:
- 최대 240개 엔트리/비디오 (약 10일치)
- 240시간 이상 오래된 데이터 자동 삭제

**월간 데이터 생성량**:
```
일일: 120,000개
월간: 120,000 × 30 = 3,600,000개
```

#### 2. View Count (현재 조회수)

**수집 주기**: 매 시간 (VPH 업데이트와 동시)
**데이터 소스**: VPH 업데이트 시 함께 수집
**저장 위치**: `view_history` 테이블의 `view_count` 컬럼

#### 3. Like Count, Comment Count (좋아요, 댓글)

**수집 주기**: 매일 자정 (00:00)
**Edge Function**: `daily-statistics-updater`
**대상 비디오**: `view_tracking_config.video_ids` (최대 5,000개)

**데이터 저장**:
- 테이블: `videos`
- 저장 데이터: `like_count`, `comment_count`
- 비디오당 일일 1회 업데이트

**일일 데이터 업데이트량**:
```
추적 비디오 수: 5,000개
일일 업데이트: 5,000개 레코드
```

#### 4. Subscriber Count (구독자 수)

**수집 주기**: 매일 자정 (00:00)
**Edge Function**: `daily-statistics-updater`
**대상**: 각 비디오의 채널 (평균 10개 비디오당 1개 채널)

**데이터 저장**:
- 테이블: `videos`
- 저장 데이터: `subscriber_count`
- 채널당 일일 1회 업데이트

**일일 데이터 업데이트량**:
```
추적 비디오 수: 5,000개
평균 채널 수: 500개 (10:1 비율)
일일 업데이트: 500개 채널
```

### 데이터 수집 순서 (시간대별)

```
00:00 (자정)
  ├─ Daily Statistics Updater 실행
  │   ├─ Like Count 업데이트 (5,000개 비디오)
  │   ├─ Comment Count 업데이트 (5,000개 비디오)
  │   └─ Subscriber Count 업데이트 (500개 채널)
  │
  └─ Hourly VPH Updater 실행
      └─ View Count 스냅샷 저장 (5,000개 비디오)

01:00, 02:00, ..., 23:00 (매 시간)
  └─ Hourly VPH Updater 실행
      └─ View Count 스냅샷 저장 (5,000개 비디오)

03:00 (오전 3시)
  └─ Search Keyword Updater 실행
      ├─ 새 영상 검색 및 추가
      └─ 기존 영상 메타데이터 업데이트
```

### 분석용 데이터 요약

| 데이터 종류 | 수집 주기 | 일일 데이터량 | 저장 위치 |
|-----------|---------|-------------|----------|
| **VPH (View Count)** | 매 시간 | 120,000개 레코드 | `view_history` |
| **Like Count** | 매일 자정 | 5,000개 업데이트 | `videos` |
| **Comment Count** | 매일 자정 | 5,000개 업데이트 | `videos` |
| **Subscriber Count** | 매일 자정 | 500개 업데이트 | `videos` |

**총 일일 분석 데이터 생성량**: 약 **130,500개 레코드/업데이트**

---

## 3️⃣ 모든 데이터베이스의 영상이 VPH 업데이트가 되려면?

### 현재 VPH 추적 제한

**현재 설정**:
- VPH 추적 대상: `view_tracking_config.video_ids` 배열
- 최대 추적 수: **5,000개** (API 할당량 관리)
- 자동 제한: `hourly-vph-updater`에서 5,000개 초과 시 자동으로 제한

### 모든 영상이 VPH 업데이트되려면?

#### 방법 1: view_tracking_config에 모든 영상 추가

**현재 상황**:
- `videos` 테이블에 저장된 영상: 수만 개 (예상)
- `view_tracking_config.video_ids`: 최대 5,000개만 추적

**모든 영상 추적하려면**:
```sql
-- 모든 영상 ID를 view_tracking_config에 추가
UPDATE view_tracking_config
SET video_ids = (
    SELECT array_agg(DISTINCT video_id)
    FROM videos
    LIMIT 5000  -- API 할당량 제한
);
```

⚠️ **문제**: API 할당량 제한으로 인해 최대 5,000개만 추적 가능

#### 방법 2: API 할당량 증가 후 제한 해제

**필요한 작업**:
1. YouTube API 할당량 증가 요청 (10,000 → 50,000 units/day)
2. `hourly-vph-updater`의 `MAX_TRACKED_VIDEOS` 제한 해제 또는 증가

**계산**:
```
현재: 5,000개 비디오 → 2,400 units/day
목표: 20,000개 비디오 → 9,600 units/day
필요 할당량: 최소 20,000 units/day
```

#### 방법 3: 로테이션 방식 (권장)

**개념**: 모든 영상을 순환하면서 추적

**구현 방법**:
1. `videos` 테이블의 모든 영상 ID를 가져옴
2. 일정 기간(예: 1주일)마다 `view_tracking_config.video_ids`를 로테이션
3. 모든 영상이 주기적으로 추적되도록 함

**예시**:
```sql
-- 주간 로테이션 (매주 월요일)
-- 1주차: video_ids 1~5,000
-- 2주차: video_ids 5,001~10,000
-- 3주차: video_ids 10,001~15,000
-- ...
```

**장점**:
- API 할당량 내에서 운영 가능
- 모든 영상이 주기적으로 추적됨
- 장기적인 데이터 수집 가능

### 현재 추적되는 영상

**자동 추가**:
- `search-keyword-updater`가 새 영상을 추가할 때 자동으로 `view_tracking_config.video_ids`에 추가됨
- 최대 5,000개까지 자동 추가

**수동 추가**:
```sql
-- 특정 영상 ID를 추적 목록에 추가
UPDATE view_tracking_config
SET video_ids = array_append(video_ids, 'VIDEO_ID_HERE')
WHERE NOT (video_ids @> ARRAY['VIDEO_ID_HERE']);
```

### VPH 추적 우선순위

**현재 로직**:
1. `search-keyword-updater`가 추가한 최신 영상이 우선
2. 최대 5,000개까지만 추적
3. 5,000개 초과 시 가장 오래된 영상부터 제외

**모든 영상 추적을 위한 권장 사항**:

1. **로테이션 방식 채택** (가장 현실적)
   - 주간 또는 월간 단위로 추적 대상 로테이션
   - 모든 영상이 주기적으로 추적됨

2. **API 할당량 증가** (장기적)
   - 20,000 units/day 이상으로 증가 요청
   - 더 많은 영상 추적 가능

3. **중요 영상 우선 추적** (현실적)
   - 조회수, 좋아요 등이 높은 영상 우선 추적
   - 나머지는 주기적으로 로테이션

---

## 📊 최종 요약

### 1. 일일 영상 구축

| 항목 | 수량 |
|------|------|
| **초기 구축** | 2,000~2,500개 |
| **정상 운영 (일일 추가)** | 약 300개 |
| **정상 운영 (일일 업데이트)** | 약 1,000개 |

### 2. 분석용 데이터 생성

| 데이터 종류 | 일일 생성량 |
|-----------|-----------|
| **VPH 데이터** | 120,000개 레코드 |
| **Like/Comment Count** | 5,000개 업데이트 |
| **Subscriber Count** | 500개 업데이트 |
| **총합** | 약 130,500개 |

### 3. VPH 추적 현황

| 항목 | 수량 |
|------|------|
| **현재 추적 가능** | 최대 5,000개 |
| **일일 VPH 데이터** | 120,000개 레코드 |
| **모든 영상 추적** | 로테이션 방식 권장 |

---

## 🎯 권장 사항

1. **현재 설정 유지**: 5,000개 영상 추적으로 안정적 운영
2. **로테이션 방식 고려**: 모든 영상을 주기적으로 추적하려면 로테이션 구현
3. **API 할당량 모니터링**: 일일 사용량이 7,750 units로 안전하게 운영 중

