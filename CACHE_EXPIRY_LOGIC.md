# 캐시 만료 후 검색 로직 (72시간)

## 현재 동작 방식

### 72시간 만료 후 처리 로직

#### 1. 만료된 캐시가 충분한 경우
```javascript
// total_count >= targetCount
if (totalCount >= targetCount) {
    // ✅ API 호출 안 함, 캐시만 사용
    // 할당량 소모: 0 units
}
```

**예시**: 
- 캐시에 100개 저장됨
- 사용자가 50개 요청
- → **API 호출 없이 캐시만 사용** ✅

#### 2. 만료된 캐시가 부족한 경우
```javascript
// count > 0 && count < targetCount
if (count > 0 && count < targetCount) {
    const neededCount = targetCount - count;
    // 기존 ID 제외하고 필요한 수만 추가로 가져오기
    await fetchAdditionalVideos(query, apiKeyValue, neededCount, existingVideoIds);
}
```

**예시**:
- 캐시에 50개 저장됨
- 사용자가 100개 요청
- → **50개만 추가로 검색** (기존 50개 ID 제외)
- 할당량 소모: 약 102 units (50개 검색)

#### 3. 만료된 캐시가 0개인 경우
```javascript
// count === 0
// → 전체 재검색
await performFullGoogleSearch(query, apiKeyValue);
```

**예시**:
- 캐시에 데이터 없음
- → **전체 재검색**
- 할당량 소모: 약 204 units (100개 검색)

## 72시간마다 자동 재검색?

### ❌ 아니요, 자동 재검색하지 않습니다

현재 로직:
- **72시간 만료 후에도 캐시가 충분하면 API 호출 안 함**
- **사용자가 검색할 때만** 필요에 따라 추가 호출
- **자동으로 72시간마다 재검색하지 않음**

### 동작 시나리오

#### 시나리오 1: 만료되었지만 충분한 캐시
```
시간: 72시간 경과
캐시: 100개 저장됨
요청: 50개
결과: ✅ 캐시만 사용 (API 호출 없음)
```

#### 시나리오 2: 만료되었고 부족한 캐시
```
시간: 72시간 경과
캐시: 50개 저장됨
요청: 100개
결과: ✅ 50개만 추가 검색 (기존 50개 ID 제외)
```

#### 시나리오 3: 만료되었고 0개 캐시
```
시간: 72시간 경과
캐시: 0개
요청: 100개
결과: ✅ 전체 재검색
```

## 할당량 소모 비교

| 상황 | API 호출 | 할당량 소모 |
|------|---------|------------|
| **만료 + 충분한 캐시** | ❌ 없음 | **0 units** |
| **만료 + 부족한 캐시** | ✅ 부분 검색 | **약 102 units** (50개) |
| **만료 + 0개 캐시** | ✅ 전체 검색 | **약 204 units** (100개) |
| **신선한 캐시** | ❌ 없음 | **0 units** |

## 최적화 효과

### 현재 로직의 장점

1. **할당량 절약**
   - 만료되었어도 충분하면 API 호출 안 함
   - 부족한 만큼만 추가 검색

2. **사용자 경험**
   - 즉시 결과 표시 (캐시 사용)
   - 필요한 만큼만 추가 로딩

3. **유연성**
   - `maxResults` 변경해도 캐시가 충분하면 API 호출 안 함

## 개선 가능한 점

### 자동 갱신이 필요한 경우

만약 72시간마다 자동으로 재검색하고 싶다면:

1. **Supabase Edge Function + pg_cron** 사용
   - 72시간마다 자동 재검색
   - 서버 측에서 실행

2. **브라우저 측 스케줄러** (현재 없음)
   - Service Worker 사용
   - 백그라운드에서 주기적 갱신

**현재는**: 사용자가 검색할 때만 필요에 따라 추가 호출

